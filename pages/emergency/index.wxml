<!--pages/emergency/index.wxml-->
<view class="container">
  <!-- 顶部安全栏 -->
  <view class="safety-bar">
    <text class="safety-icon">⚠️</text>
    <text class="safety-text">此页面仅供紧急情况下医疗/救援人员查看</text>
  </view>

  <!-- 加载中状态 -->
  <view wx:if="{{loading}}" class="loading-container">
    <view class="loading-icon">⏳</view>
    <text class="loading-text">正在加载急救信息...</text>
  </view>

  <!-- 有数据时显示内容 -->
  <view wx:elif="{{cardData}}" class="content-wrapper">
    <!-- 身份核验区 -->
    <view class="info-card header-card">
      <view class="avatar-area">
        <view class="avatar-placeholder">
          <text class="avatar-icon">👤</text>
        </view>
      </view>
      <view class="user-details">
        <view class="name-row">
          <text class="user-name">{{cardData.name}}</text>
          <view class="verified-badge">
            <text>已实名</text>
          </view>
        </view>
        <text class="user-age">{{cardData.age}}岁</text>
      </view>
    </view>

    <!-- 家人寄语 -->
    <view class="note-section" wx:if="{{true}}">
      <text class="note-text">“ 如有不适请出示此卡，请好好爱自己。💝 ”</text>
    </view>

    <!-- 关键医疗信息区 - 网格布局（2列：血型和过敏） -->
    <view class="grid-row">
      <view class="info-card grid-item">
        <view class="card-label">
          <text class="icon">🩸</text> 血型
        </view>
        <text class="card-value value-highlight">{{cardData.blood_type}}</text>
      </view>

      <view class="info-card grid-item">
        <view class="card-label">
          <view class="icon icon-allergy"></view> 过敏史
        </view>
        <text class="card-value {{allergyInfo !== '无已知过敏' ? 'text-red' : ''}}">{{allergyInfo}}</text>
      </view>
    </view>

    <!-- 常用药物展示栏 -->
    <view class="info-card">
      <view class="section-title">💊 正在服药</view>
      <view class="tag-container">
        <block wx:if="{{medicationsTags.length > 0}}">
          <view class="tag tag-blue" wx:for="{{medicationsTags}}" wx:key="index">{{item}}</view>
        </block>
        <text wx:else class="empty-text">无正在服用药物</text>
      </view>
    </view>

    <!-- 完整病史/过敏区块 -->
    <view class="info-card" wx:if="{{cardData.conditions}}">
      <view class="section-title">🏥 既往病史</view>
      <view class="tag-container">
        <block wx:if="{{conditionsTags.length > 0}}">
          <view class="tag tag-orange" wx:for="{{conditionsTags}}" wx:key="index">{{item}}</view>
        </block>
        <text wx:else class="empty-text">无重大病史</text>
      </view>
    </view>

    <!-- 最近更新时间 -->
    <view class="update-time-section">
      <text class="update-time-text">最后更新：{{updateTime || '未知'}}</text>
    </view>
  </view>

  <!-- 加载完成但没有数据时显示错误 -->
  <view wx:else class="error-container">
    <text class="error-icon">❌</text>
    <text class="error-text">信息获取失败或已失效</text>
    <button class="back-btn" bindtap="onGoBack">返回首页</button>
  </view>

  <!-- 底部固定行动栏 -->
  <view class="fixed-footer" wx:if="{{cardData}}">
    <button class="call-btn" bindtap="onMakePhoneCall">
      <text class="phone-icon">📞</text>
      <text>拨打紧急联系人</text>
    </button>
  </view>
</view>
