<!--pages/emergency/index.wxml-->
<view class="container">
  <!-- 顶部安全栏 -->
  <view class="safety-bar">
    <text class="safety-icon">⚠️</text>
    <text class="safety-text">此页面仅供紧急情况下医疗/救援人员查看</text>
  </view>

  <!-- 加载中状态 -->
  <view wx:if="{{loading}}" class="loading-container">
    <view class="loading-icon">⏳</view>
    <text class="loading-text">正在加载急救信息...</text>
  </view>

  <!-- 有数据时显示内容 -->
  <view wx:elif="{{cardData}}" class="content-wrapper">
    <!-- 身份核验区 -->
    <view class="info-card header-card">
      <view class="avatar-area">
        <image 
          class="avatar" 
          mode="aspectFill" 
          src="{{cardData.avatar ? cardData.avatar : ''}}"
          wx:if="{{cardData.avatar}}"
        ></image>
        <view class="avatar-placeholder" wx:else>
          <text class="avatar-icon">👤</text>
        </view>
      </view>
      <view class="user-details">
        <view class="name-row">
          <text class="user-name">{{cardData.name}}</text>
          <view class="verified-badge">
            <text>已实名</text>
          </view>
        </view>
      </view>
    </view>

    <!-- 家人寄语 -->
    <view class="note-section" wx:if="{{true}}">
      <text class="note-text">" 如有不适请出示此卡，请好好爱自己。💝 "</text>
    </view>

    <!-- 关键医疗信息区 - 网格布局 -->
    <view class="card-grid">
      <!-- 第一行：血型和年龄 -->
      <view class="grid-row">
        <view class="info-card half">
          <view class="card-label">
            <text class="icon">🩸</text>
            <text>血型</text>
          </view>
          <text class="card-value highlight">{{cardData.blood_type || '未知'}}</text>
        </view>
        <view class="info-card half">
          <view class="card-label">
            <text class="icon">👴</text>
            <text>年龄</text>
          </view>
          <text class="card-value">{{cardData.age}}岁</text>
        </view>
      </view>

      <!-- 第二行：过敏史 -->
      <view class="info-card full">
        <view class="card-label">
          <view class="icon icon-allergy"></view>
          <text>过敏史</text>
        </view>
        <view class="tags-container">
          <block wx:if="{{allergyInfo && allergyInfo !== '无已知过敏'}}">
            <text class="clean-tag">{{allergyInfo}}</text>
          </block>
          <text wx:else class="empty-text">无已知过敏</text>
        </view>
      </view>

      <!-- 第三行：正在服药 -->
      <view class="info-card full">
        <view class="card-label">
          <text class="icon">💊</text>
          <text>正在服药</text>
        </view>
        <view class="tags-container">
          <block wx:if="{{medicationsTags.length > 0}}">
            <text class="clean-tag" wx:for="{{medicationsTags}}" wx:key="index">{{item}}</text>
          </block>
          <text wx:else class="empty-text">无正在服用药物</text>
        </view>
      </view>

      <!-- 第四行：既往病史 -->
      <view class="info-card full" wx:if="{{cardData.conditions}}">
        <view class="card-label">
          <text class="icon">🏥</text>
          <text>既往病史</text>
        </view>
        <view class="tags-container">
          <block wx:if="{{conditionsTags.length > 0}}">
            <text class="clean-tag" wx:for="{{conditionsTags}}" wx:key="index">{{item}}</text>
          </block>
          <text wx:else class="empty-text">无重大病史</text>
        </view>
      </view>
    </view>

    <!-- 最近更新时间 -->
    <view class="update-time-section">
      <text class="update-time-text">最后更新：{{updateTime || '未知'}}</text>
    </view>
  </view>

  <!-- 加载完成但没有数据时显示错误 -->
  <view wx:else class="error-container">
    <text class="error-icon">❌</text>
    <text class="error-text">信息获取失败或已失效</text>
    <button class="back-btn" bindtap="onGoBack">返回首页</button>
  </view>

  <!-- 底部固定行动栏 -->
  <view class="fixed-footer" wx:if="{{cardData}}">
    <button class="call-btn" bindtap="onMakePhoneCall">
      <text class="phone-icon">📞</text>
      <text>紧急联系人电话</text>
    </button>
  </view>
</view>
