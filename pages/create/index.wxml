<!--pages/create/index.wxml-->
<view class="container">
  <view class="header">
    <text class="title">{{editId ? '编辑卡片信息' : '创建紧急联系卡'}}</text>
    <text class="subtitle">{{editId ? '修改卡片信息，确保信息准确无误' : '为需要帮助者填写基本信息，关键时刻能救命'}}</text>
  </view>

  <view class="form-container">
    <view class="form-item">
      <text class="label">姓名 *</text>
      <input 
        class="input" 
        placeholder="请输入姓名" 
        value="{{formData.name}}"
        bindinput="onNameInput"
        maxlength="20"
      />
    </view>

    <view class="form-item">
      <text class="label">年龄 *</text>
      <input 
        class="input" 
        type="number" 
        placeholder="请输入年龄" 
        value="{{formData.age}}"
        bindinput="onAgeInput"
      />
    </view>

    <view class="form-item blood-type-item">
      <text class="label">血型 *</text>
      <picker 
        mode="selector" 
        range="{{bloodTypes}}" 
        value="{{bloodTypeIndex}}"
        bindchange="onBloodTypeChange"
      >
        <view class="picker {{formData.blood_type ? '' : 'placeholder'}}">
          {{formData.blood_type || '请选择血型'}}
        </view>
      </picker>
    </view>

    <view class="form-item">
      <text class="label">主要病史/过敏史</text>
      <text class="form-tip">不同病史、过敏史等可用逗号或换行分隔</text>
      <textarea 
        class="textarea" 
        placeholder="请输入主要病史、过敏史等信息（如：高血压、糖尿病、对青霉素过敏等）" 
        value="{{formData.conditions}}"
        bindinput="onConditionsInput"
        maxlength="200"
        auto-height
      />
    </view>

    <view class="form-item">
      <text class="label">常用药物</text>
      <text class="form-tip">请输入经常在服用的药物名称</text>
      <textarea 
        class="textarea" 
        placeholder="请输入常用药物名称（如：阿司匹林、降压药等）" 
        value="{{formData.medications}}"
        bindinput="onMedicationsInput"
        maxlength="200"
        auto-height
      />
    </view>

    <view class="form-item">
      <text class="label">家属称呼 *</text>
      <input 
        class="input" 
        placeholder="如：儿子、女儿等" 
        value="{{formData.contact_name}}"
        bindinput="onContactNameInput"
        maxlength="10"
      />
    </view>

    <view class="form-item">
      <text class="label">家属电话 *</text>
      <input 
        class="input" 
        type="number" 
        placeholder="请输入家属联系电话" 
        value="{{formData.contact_phone}}"
        bindinput="onContactPhoneInput"
        maxlength="11"
      />
    </view>
  </view>

  <!-- 隐私协议复选框 -->
  <view class="privacy-row">
    <view class="checkbox-container" bindtap="toggleAgree">
      <view class="checkbox {{isAgreed ? 'checked' : ''}}">
        <text wx:if="{{isAgreed}}" class="check-icon">✓</text>
      </view>
      <text class="privacy-label">我已阅读并同意</text>
    </view>
    <view class="privacy-link" catchtap="showPrivacyModal">《隐私保护及服务条款》</view>
  </view>

  <button class="submit-btn" bindtap="onSubmit" disabled="{{isSubmitting || isGeneratingQR}}">
    {{isGeneratingQR ? '生成中...' : (isSubmitting ? '保存中...' : (editId ? '保存修改' : '生成安心卡'))}}
  </button>
</view>

<!-- 隐私协议弹窗 -->
<view wx:if="{{showPrivacyModal}}" class="privacy-modal">
  <view class="privacy-modal-content" catchtap="stopPropagation">
    <view class="privacy-modal-header">
      <text class="privacy-modal-title">隐私保护及服务条款</text>
      <text class="privacy-modal-close" bindtap="onClosePrivacyModal">×</text>
    </view>
    <view class="privacy-modal-body">
      <view class="privacy-content">
        <view class="privacy-item">
          <text class="privacy-item-title">1.【传输与存储安全】</text>
          <text class="privacy-item-text">您的数据全程采用 HTTPS 银行级加密传输，并存储于腾讯云安全服务器。我们承诺严格控制权限，仅供急救场景展示。</text>
        </view>
        
        <view class="privacy-item">
          <text class="privacy-item-title">2.【数据准确性与免责】(重要)</text>
          <text class="privacy-item-text">【屏安守护】小程序仅作为信息记录工具，不对用户自行填写内容的真实性、准确性负责。请务必确保您录入的血型、病史、药物过敏等信息准确无误。因信息填写错误导致的任何医疗后果，开发者不承担法律责任。</text>
        </view>

        <view class="privacy-item">
          <text class="privacy-item-title">3.【隐私公开风险告知】</text>
          <text class="privacy-item-text">生成"屏安守护"壁纸即意味着您同意将上述急救信息展示在手机锁屏界面。这意味着任何人（包括捡到手机的陌生人）均可看到。请您根据自身情况，谨慎选择展示的信息详略程度。</text>
        </view>

        <view class="privacy-item">
          <text class="privacy-item-title">4.【防诈骗提醒】</text>
          <text class="privacy-item-text">请妥善保管您的设备。若您的紧急联系人接到"亲人出事"或"急需汇款"的电话，请务必先通过视频、警方或医院官方渠道核实身份，切勿轻信转账。【屏安守护】小程序无法鉴别扫码者身份，对诈骗行为不承担责任。</text>
        </view>

        <view class="privacy-item">
          <text class="privacy-item-title">5.【服务性质申明】</text>
          <text class="privacy-item-text">【屏安守护】小程序为个人开发者提供的免费辅助工具，非专业医疗设备。因网络故障、系统兼容性或不可抗力导致的信息无法读取，开发者不承担连带责任。</text>
        </view>
        
        <view class="privacy-item">
          <text class="privacy-item-title">6.【数据销毁】</text>
          <text class="privacy-item-text">您拥有完全控制权。删除急救卡后，云端数据将立即被物理销毁，不留备份。</text>
        </view>
      </view>
    </view>
    <view class="privacy-modal-footer">
      <button class="privacy-modal-btn" bindtap="onClosePrivacyModal">确认</button>
    </view>
  </view>
</view>

<!-- 二维码展示模态框 -->
<view class="qr-modal {{showQRModal ? 'show' : ''}}" catchtap="onCloseQRModal">
  <view class="qr-modal-content" catchtap="stopPropagation">
    <view class="qr-modal-header">
      <text class="qr-modal-title">📱 专属急救二维码</text>
      <text class="qr-modal-close" bindtap="onCloseQRModal">✕</text>
    </view>
    
    <view class="qr-modal-body">
      <text class="qr-modal-desc">扫描二维码即可查看紧急医疗信息</text>
      <image 
        class="qr-code-image" 
        src="{{qrCodeFileID}}" 
        mode="aspectFit"
        show-menu-by-longpress="{{true}}"
      />
      <text class="qr-modal-tip">长按图片也可以保存到相册</text>
    </view>

    <view class="qr-modal-footer">
      <button class="qr-btn save-btn" bindtap="onSaveQRCode">保存图片到相册</button>
      <button class="qr-btn view-btn" bindtap="onViewEmergencyCard">查看急救卡</button>
    </view>
  </view>
</view>

