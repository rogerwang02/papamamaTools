<!DOCTYPE html>
<html lang="zh-CN">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ç´§æ€¥åŒ»ç–—ä¿¡æ¯ | å±å®‰å®ˆæŠ¤</title>
    <script src="https://static.cloudbase.net/cloudbase-js-sdk/latest/cloudbase.full.js"></script>
    <style>
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", "PingFang SC", "Hiragino Sans GB", "Microsoft YaHei", sans-serif;
            background-color: #F7F8FA;
            color: #333;
            line-height: 1.6;
        }

        .container {
            min-height: 100vh;
            padding-bottom: 80px;
        }

        /* é¡¶éƒ¨å®‰å…¨æ  */
        .safety-bar {
            background-color: #FEF0F0;
            padding: 12px 15px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .safety-icon {
            font-size: 16px;
            margin-right: 6px;
        }

        .safety-text {
            font-size: 12px;
            color: #D32F2F;
            font-weight: 500;
            line-height: 1.5;
        }

        /* å†…å®¹åŒºåŸŸ */
        .content-wrapper {
            padding: 15px;
            max-width: 750px;
            margin: 0 auto;
        }

        /* Common Card Style */
        .info-card {
            background: #FFFFFF;
            border-radius: 12px;
            padding: 15px;
            margin-bottom: 12px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.03);
            box-sizing: border-box;
            width: 100%;
        }

        /* 1. Header Styles */
        .header-card {
            display: flex;
            align-items: center;
            padding: 20px 15px;
        }

        .user-details {
            flex: 1;
            display: flex;
            flex-direction: column;
        }

        .name-row {
            display: flex;
            align-items: center;
            margin-bottom: 4px;
        }

        .user-name {
            font-size: 20px;
            font-weight: bold;
            color: #333;
        }

        /* 2. Note Styles */
        .note-section {
            margin-bottom: 12px;
            padding: 0 5px;
        }

        .note-text {
            font-size: 14px;
            color: #888;
            font-style: italic;
            line-height: 1.5;
            display: block;
        }

        /* 3. Grid Styles */
        .card-grid {
            display: flex;
            flex-direction: column;
        }

        .grid-row {
            display: flex;
            justify-content: space-between;
            margin-bottom: 12px;
            gap: 4%;
        }

        .info-card.half {
            width: 48%;
            box-sizing: border-box;
        }

        .info-card.full {
            width: 100%;
            margin-bottom: 12px;
            box-sizing: border-box;
        }

        .card-label {
            font-size: 15px;
            font-weight: bold;
            color: #666;
            margin-bottom: 8px;
            display: flex;
            align-items: center;
        }

        .card-label .icon {
            margin-right: 4px;
            font-size: 18px;
        }

        /* é»„è‰²åœ†å½¢è­¦å‘Šå›¾æ ‡ */
        .icon-allergy {
            width: 16px;
            height: 16px;
            background-color: #FFB800;
            border-radius: 50%;
            margin-right: 4px;
            position: relative;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            vertical-align: middle;
            flex-shrink: 0;
        }

        .icon-allergy::after {
            content: '!';
            color: #FFF;
            font-size: 10px;
            font-weight: bold;
            line-height: 1;
            font-family: Arial, sans-serif;
        }

        .card-value {
            font-size: 17px;
            font-weight: 600;
            color: #333;
        }

        .card-value.highlight {
            color: #FF8C00;
            font-size: 20px;
        }

        /* 4. Tags Styles - Unified Orange Theme */
        .tags-container {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
        }

        .clean-tag {
            background-color: #FFF7E6;
            color: #FF8C00;
            font-size: 14px;
            padding: 6px 12px;
            border-radius: 6px;
            font-weight: 500;
        }

        .empty-text {
            color: #ccc;
            font-size: 14px;
        }

        /* æœ€è¿‘æ›´æ–°æ—¶é—´ */
        .update-time-section {
            text-align: center;
            padding: 10px 0;
            margin-top: 5px;
        }

        .update-time-text {
            font-size: 12px;
            color: #999;
            line-height: 1.5;
        }

        /* Footer */
        .fixed-footer {
            position: fixed;
            bottom: 0;
            left: 0;
            width: 100%;
            background: #fff;
            padding: 10px 20px;
            padding-bottom: calc(10px + env(safe-area-inset-bottom));
            box-shadow: 0 -4px 16px rgba(0, 0, 0, 0.05);
            box-sizing: border-box;
        }

        .call-btn {
            background: linear-gradient(135deg, #FF3B30, #FF6B00);
            color: #fff;
            border-radius: 25px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 16px;
            font-weight: bold;
            height: 44px;
            box-shadow: 0 4px 10px rgba(255, 59, 48, 0.3);
            width: 100%;
            border: none;
            text-decoration: none;
            cursor: pointer;
        }

        .phone-icon {
            margin-right: 8px;
            font-size: 18px;
        }

        /* Conversion Button (Secondary) */
        .conversion-area {
            margin-top: 12px;
            /* padding-top: 12px; */
            border-top: 1px solid #F0F0F0;
        }

        .convert-btn {
            display: block;
            width: 100%;
            text-align: center;
            padding: 12px;
            margin-top: 0;
            background-color: transparent;
            border: 2px solid #E0E0E0;
            border-radius: 25px;
            color: #666;
            font-size: 14px;
            font-weight: 600;
            text-decoration: none;
            transition: all 0.2s;
            cursor: pointer;
            box-sizing: border-box;
        }

        .convert-btn:active {
            background-color: #f0f0f0;
            border-color: #ccc;
        }

        /* Helper Text */
        .convert-hint {
            font-size: 11px;
            color: #999;
            text-align: center;
            margin-top: 8px;
            margin-bottom: 0;
        }

        /* äºŒç»´ç æµ®å±‚å®¹å™¨ï¼ˆå³ä¸‹è§’ï¼‰ */
        .qr-float-layer {
            position: fixed;
            bottom: 110px;
            right: 20px; /* å±•å¼€çŠ¶æ€ï¼šæµ®å±‚å³ä¾§è·ç¦»å±å¹•å³è¾¹ç•Œ20px */
            z-index: 999;
            display: flex;
            align-items: flex-start; /* ä¸Šè¾¹ç¼˜å¯¹é½ */
            transition: transform 0.3s ease-in-out;
        }

        /* æ”¶èµ·çŠ¶æ€ï¼šæ•´ä¸ªå®¹å™¨å‘å³ç§»åŠ¨ï¼Œæµ®å±‚å®Œå…¨ç§»å‡ºå±å¹•ï¼ŒæŒ‰é’®å³ä¾§è´´ç´§å±å¹•å³è¾¹ç•Œ */
        /* æµ®å±‚å®½åº¦ = 140px(max-width) + 32px(padding) = 172pxï¼Œç§»åŠ¨è·ç¦»å°±æ˜¯æµ®å±‚å®½åº¦ */
        .qr-float-layer.collapsed {
            transform: translateX(165px);
            /* ç§»åŠ¨172pxï¼Œè®©æµ®å±‚å®Œå…¨ç§»å‡ºï¼ŒæŒ‰é’®è´´ç€å³è¾¹ç•Œ */
        }

        /* å±•å¼€/æ”¶èµ·æŒ‰é’® - åœ¨æµ®å±‚å·¦ä¾§ï¼Œä¸Šè¾¹ç¼˜å¯¹é½ */
        .qr-toggle-btn {
            width: 36px;
            height: 36px;
            background: #FFFFFF;
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.15);
            transition: all 0.2s;
            flex-shrink: 0;
            margin-right: 0; /* æŒ‰é’®å³ä¾§ç´§è´´æµ®å±‚å·¦ä¾§ */
        }

        .qr-float-content {
            background: #FFFFFF;
            border-radius: 16px;
            padding: 16px;
            box-shadow: 0 8px 24px rgba(0, 0, 0, 0.15);
            display: flex;
            flex-direction: column;
            align-items: center;
            max-width: 140px;
            margin-left: 0; /* æµ®å±‚å·¦ä¾§ç´§è´´æŒ‰é’®å³ä¾§ */
        }

        .qr-toggle-btn:active {
            transform: scale(0.95);
        }

        /* äºŒç»´ç å›¾æ ‡ - ä½¿ç”¨SVGç»˜åˆ¶ */
        .qr-icon {
            width: 20px;
            height: 20px;
            background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='%23333'%3E%3Cpath d='M3 3h7v7H3z'/%3E%3Cpath d='M14 3h7v7h-7z'/%3E%3Cpath d='M3 14h7v7H3z'/%3E%3Crect x='14' y='14' width='3' height='3'/%3E%3Crect x='18' y='14' width='3' height='3'/%3E%3Crect x='14' y='18' width='3' height='3'/%3E%3Cpath d='M11 8h2v8h-2z'/%3E%3Cpath d='M8 11h8v2H8z'/%3E%3C/svg%3E");
            background-repeat: no-repeat;
            background-position: center;
            background-size: contain;
        }

        .qr-text-line {
            font-size: 12px;
            color: #333;
            line-height: 1.2;
            text-align: center;
            margin-bottom: 8px;
            font-weight: 500;
        }

        .qr-text-line:first-child {
            color: #FF8C00;
            font-weight: 600;
        }

        .mp-qrcode {
            width: 100px;
            height: 100px;
            border-radius: 8px;
            margin-top: 4px;
            display: block;
        }

        /* é”™è¯¯çŠ¶æ€ */
        .loading-container {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 100px 40px;
            text-align: center;
            min-height: 60vh;
        }

        .loading-icon {
            font-size: 60px;
            display: block;
            margin-bottom: 20px;
            animation: rotate 2s linear infinite;
        }

        @keyframes rotate {
            from {
                transform: rotate(0deg);
            }

            to {
                transform: rotate(360deg);
            }
        }

        .loading-text {
            font-size: 16px;
            color: #666;
            line-height: 1.6;
        }

        .error-container {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 100px 40px;
            text-align: center;
            min-height: 60vh;
        }

        .error-icon {
            font-size: 100px;
            margin-bottom: 40px;
        }

        .error-text {
            font-size: 36px;
            color: #666;
            margin-bottom: 60px;
            line-height: 1.6;
        }

        .back-btn {
            width: 400px;
            height: 88px;
            background-color: #FF6B00;
            color: #fff;
            font-size: 32px;
            border-radius: 44px;
            display: flex;
            align-items: center;
            justify-content: center;
            border: none;
            cursor: pointer;
        }

        /* éšè—å…ƒç´  */
        .hidden {
            display: none !important;
        }

        @media (max-width: 480px) {
            .content-wrapper {
                padding: 20px;
            }

            .user-name {
                font-size: 32px;
            }

            .grid-row {
                flex-direction: column;
            }

            .info-card.half {
                width: 100%;
            }
        }
    </style>
</head>

<body>
    <div class="container">
        <!-- é¡¶éƒ¨å®‰å…¨æ  -->
        <div class="safety-bar">
            <span class="safety-icon">âš ï¸</span>
            <span class="safety-text">æ­¤é¡µé¢ä»…ä¾›ç´§æ€¥æƒ…å†µä¸‹åŒ»ç–—/æ•‘æ´äººå‘˜æŸ¥çœ‹</span>
        </div>

        <!-- åŠ è½½ä¸­çŠ¶æ€ -->
        <div id="loading" class="loading-container">
            <div class="loading-icon">â³</div>
            <div class="loading-text">æ­£åœ¨åŠ è½½æ€¥æ•‘ä¿¡æ¯...</div>
        </div>

        <!-- æœ‰æ•°æ®æ—¶æ˜¾ç¤ºå†…å®¹ -->
        <div id="content-wrapper" class="content-wrapper hidden">
            <!-- èº«ä»½æ ¸éªŒåŒº -->
            <div class="info-card header-card">
                <div class="user-details">
                    <div class="name-row">
                        <span class="user-name" id="user-name">æœªçŸ¥</span>
                    </div>
                </div>
            </div>

            <!-- å®¶äººå¯„è¯­ -->
            <div class="note-section">
                <span class="note-text">" å¦‚æœ‰ä¸é€‚è¯·å‡ºç¤ºæ­¤å¡ï¼Œè¯·å¥½å¥½çˆ±è‡ªå·±ã€‚ğŸ’ "</span>
            </div>

            <!-- å…³é”®åŒ»ç–—ä¿¡æ¯åŒº - ç½‘æ ¼å¸ƒå±€ -->
            <div class="card-grid">
                <!-- ç¬¬ä¸€è¡Œï¼šè¡€å‹å’Œå¹´é¾„ -->
                <div class="grid-row">
                    <div class="info-card half">
                        <div class="card-label">
                            <span class="icon">ğŸ©¸</span>
                            <span>è¡€å‹</span>
                        </div>
                        <div class="card-value highlight" id="blood-type">æœªçŸ¥</div>
                    </div>
                    <div class="info-card half">
                        <div class="card-label">
                            <span class="icon">ğŸ‘´</span>
                            <span>å¹´é¾„</span>
                        </div>
                        <div class="card-value" id="age">?</div>
                    </div>
                </div>

                <!-- ç¬¬äºŒè¡Œï¼šè¿‡æ•å² -->
                <div class="info-card full">
                    <div class="card-label">
                        <div class="icon-allergy"></div>
                        <span>è¿‡æ•å²</span>
                    </div>
                    <div class="tags-container" id="allergy-container">
                        <span class="empty-text">æ— å·²çŸ¥è¿‡æ•</span>
                    </div>
                </div>

                <!-- ç¬¬ä¸‰è¡Œï¼šæ­£åœ¨æœè¯ -->
                <div class="info-card full">
                    <div class="card-label">
                        <span class="icon">ğŸ’Š</span>
                        <span>æ­£åœ¨æœè¯</span>
                    </div>
                    <div class="tags-container" id="medications-container">
                        <span class="empty-text">æ— æ­£åœ¨æœç”¨è¯ç‰©</span>
                    </div>
                </div>

                <!-- ç¬¬å››è¡Œï¼šæ—¢å¾€ç—…å² -->
                <div class="info-card full hidden" id="history-card">
                    <div class="card-label">
                        <span class="icon">ğŸ¥</span>
                        <span>æ—¢å¾€ç—…å²</span>
                    </div>
                    <div class="tags-container" id="history-container">
                        <span class="empty-text">æ— é‡å¤§ç—…å²</span>
                    </div>
                </div>
            </div>

            <!-- æœ€è¿‘æ›´æ–°æ—¶é—´ -->
            <div class="update-time-section">
                <span class="update-time-text" id="update-time">æœ€åæ›´æ–°ï¼šæœªçŸ¥</span>
            </div>
        </div>

        <!-- åŠ è½½å®Œæˆä½†æ²¡æœ‰æ•°æ®æ—¶æ˜¾ç¤ºé”™è¯¯ -->
        <div id="error" class="error-container hidden">
            <div class="error-icon">âŒ</div>
            <div class="error-text">ä¿¡æ¯è·å–å¤±è´¥æˆ–å·²å¤±æ•ˆ</div>
            <div class="error-msg" id="error-msg"></div>
        </div>

        <!-- äºŒç»´ç æµ®å±‚ï¼ˆå³ä¸‹è§’ï¼‰ -->
        <div id="qr-fallback-area" class="qr-float-layer hidden">
            <div class="qr-toggle-btn" id="qr-toggle-btn" onclick="toggleQRFloat()">
                <div class="qr-icon"></div>
            </div>
            <div class="qr-float-content">
                <div class="qr-text-line">æˆ‘ä¹Ÿæƒ³åˆ¶ä½œæ€¥æ•‘å¡</div>
                <div class="qr-text-line">è¯·æ‰«äºŒç»´ç å¼€å§‹åˆ¶ä½œ</div>
                <img src="pinganQrcode.png" id="mp-qrcode-img" class="mp-qrcode" alt="å°ç¨‹åºç ">
            </div>
        </div>

        <!-- åº•éƒ¨å›ºå®šè¡ŒåŠ¨æ  -->
        <div id="fixed-footer" class="fixed-footer hidden">
            <a href="#" id="call-btn" class="call-btn">
                <span class="phone-icon">ğŸ“</span>
                <span>ç´§æ€¥è”ç³»äººç”µè¯</span>
            </a>
            <div class="conversion-area">
                <div class="convert-hint">å±å®‰å®ˆæŠ¤ Â· æ°¸ä¹…å…è´¹ Â· å…³çˆ±å®¶äºº</div>
            </div>
        </div>
    </div>

    <script>
        // âš ï¸ æ›¿æ¢ä¸ºæ‚¨è‡ªå·±çš„ç¯å¢ƒ ID
        const ENV_ID = 'cloud1-0gum144f4caaf976'; // ä»äº‘å¼€å‘æ§åˆ¶å°è·å–

        // ä»ç—…å²ä¸­æå–è¿‡æ•ä¿¡æ¯
        function extractAllergy(conditions) {
            if (!conditions) return 'æ— å·²çŸ¥è¿‡æ•';

            const separators = /[,\n;ï¼Œï¼›ã€]/;
            const items = conditions.split(separators).map(item => item.trim()).filter(item => item.length > 0);

            const allergyKeywords = ['è¿‡æ•', 'è¿‡æ•å²', 'è¿‡æ•æº', 'ä¸åƒ', 'ä¸æœ', 'ä¸èƒ½åƒ', 'ä¸èƒ½æœ', 'ç¦ç”¨', 'å¿Œç”¨'];

            for (const item of items) {
                if (allergyKeywords.some(keyword => item.includes(keyword))) {
                    let cleanedItem = item;
                    cleanedItem = cleanedItem.replace(/ä¸èƒ½åƒ|ä¸èƒ½æœ|è¿‡æ•å²|è¿‡æ•æº/g, '');
                    cleanedItem = cleanedItem.replace(/è¿‡æ•/g, '');
                    cleanedItem = cleanedItem.replace(/ä¸åƒ|ä¸æœ/g, '');
                    cleanedItem = cleanedItem.replace(/ç¦ç”¨|å¿Œç”¨/g, '');
                    cleanedItem = cleanedItem.replace(/^å¯¹|^çš„|çš„å¯¹$|çš„$|å¯¹$/g, '');
                    cleanedItem = cleanedItem.trim();

                    if (cleanedItem.length > 0) {
                        return cleanedItem + 'ç­‰';
                    }
                }
            }

            return 'æ— å·²çŸ¥è¿‡æ•';
        }

        // å°†æ–‡æœ¬è§£æä¸ºæ ‡ç­¾æ•°ç»„
        function parseConditionsToTags(text) {
            if (!text || !text.trim()) {
                return [];
            }

            const separators = /[,\n;ï¼Œï¼›ã€]/;
            const tags = text
                .split(separators)
                .map(tag => tag.trim())
                .filter(tag => tag.length > 0);

            return tags;
        }

        // æ ¼å¼åŒ–æ—¥æœŸï¼ˆå¤„ç†äº‘æ•°æ®åº“è¿”å›çš„æ—¶é—´æ ¼å¼ï¼‰
        function formatDate(dateValue) {
            if (!dateValue) return 'æœªçŸ¥';
            
            let date;
            try {
                if (dateValue instanceof Date) {
                    date = dateValue;
                } else if (typeof dateValue === 'string') {
                    date = new Date(dateValue);
                } else if (dateValue.seconds) {
                    // äº‘æ•°æ®åº“ Timestamp å¯¹è±¡
                    date = new Date(dateValue.seconds * 1000);
                } else {
                    date = new Date(dateValue);
                }
                
                // æ£€æŸ¥æ—¥æœŸæ˜¯å¦æœ‰æ•ˆ
                if (isNaN(date.getTime())) {
                    return 'æœªçŸ¥';
                }
                
                const year = date.getFullYear();
                const month = String(date.getMonth() + 1).padStart(2, '0');
                const day = String(date.getDate()).padStart(2, '0');
                return `${year}-${month}-${day}`;
            } catch (e) {
                console.error('æ—¥æœŸæ ¼å¼åŒ–å¤±è´¥:', e);
                return 'æœªçŸ¥';
            }
        }

        // æ¸²æŸ“æ ‡ç­¾åˆ°å®¹å™¨
        function renderTags(containerId, tags, emptyText) {
            const container = document.getElementById(containerId);
            container.innerHTML = '';

            if (tags && tags.length > 0) {
                tags.forEach(tag => {
                    const tagEl = document.createElement('span');
                    tagEl.className = 'clean-tag';
                    tagEl.textContent = tag;
                    container.appendChild(tagEl);
                });
            } else {
                const emptyEl = document.createElement('span');
                emptyEl.className = 'empty-text';
                emptyEl.textContent = emptyText;
                container.appendChild(emptyEl);
            }
        }

        async function init() {
            try {
                // 1. åˆå§‹åŒ– CloudBase
                const app = cloudbase.init({
                    env: ENV_ID
                });
                const auth = app.auth({
                    persistence: 'local'
                });

                // 2. åŒ¿åç™»å½•
                console.log('æ­£åœ¨åŒ¿åç™»å½•...');
                const loginState = await auth.getLoginState();
                if (!loginState) {
                    await auth.signInAnonymously();
                }
                console.log('åŒ¿åç™»å½•æˆåŠŸ');

                // 3. è·å– URL å‚æ•° ID
                const params = new URLSearchParams(window.location.search);
                const id = params.get('id');
                if (!id) {
                    throw new Error('æ— æ•ˆçš„æ€¥æ•‘å¡é“¾æ¥ï¼Œç¼ºå°‘IDå‚æ•°');
                }
                console.log('å¡ç‰‡ID:', id);

                // 4. è°ƒç”¨å®‰å…¨ç½‘å…³ (äº‘å‡½æ•°)
                console.log('æ­£åœ¨è°ƒç”¨äº‘å‡½æ•°è·å–æ•°æ®...');
                const res = await app.callFunction({
                    name: 'getCardDetail',
                    data: { cardId: id }
                });

                console.log('äº‘å‡½æ•°å“åº”:', res);

                if (res.result && res.result.code === 0) {
                    const data = res.result.data;
                    console.log('æ•°æ®è·å–æˆåŠŸ:', data);
                    renderData(data);
                } else {
                    throw new Error(res.result?.msg || 'ä¿¡æ¯è·å–å¤±è´¥æˆ–å·²åˆ é™¤');
                }

            } catch (err) {
                console.error('é”™è¯¯:', err);
                document.getElementById('loading').classList.add('hidden');
                document.getElementById('error').classList.remove('hidden');
                const errorMsg = document.getElementById('error-msg');
                if (errorMsg) {
                    errorMsg.textContent = err.message || 'ä¿¡æ¯è·å–å¤±è´¥æˆ–å·²å¤±æ•ˆ';
                }
            }
        }

        // åˆ‡æ¢äºŒç»´ç æµ®å±‚å±•å¼€/æ”¶èµ·
        function toggleQRFloat() {
            const qrLayer = document.getElementById('qr-fallback-area');
            const isCollapsed = qrLayer.classList.contains('collapsed');
            
            if (isCollapsed) {
                // å±•å¼€
                qrLayer.classList.remove('collapsed');
            } else {
                // æ”¶èµ·
                qrLayer.classList.add('collapsed');
            }
        }

        // æ¸²æŸ“æ•°æ®
        function renderData(data) {
            // éšè—åŠ è½½çŠ¶æ€
            document.getElementById('loading').classList.add('hidden');
            document.getElementById('content-wrapper').classList.remove('hidden');
            
            // æ˜¾ç¤ºäºŒç»´ç æµ®å±‚
            const qrLayer = document.getElementById('qr-fallback-area');
            qrLayer.classList.remove('hidden');
            
            // 3ç§’åè‡ªåŠ¨æ”¶èµ·
            setTimeout(() => {
                qrLayer.classList.add('collapsed');
            }, 3000);

            // æ¸²æŸ“å§“å
            document.getElementById('user-name').textContent = data.name || 'æœªçŸ¥';

            // æ¸²æŸ“è¡€å‹
            document.getElementById('blood-type').textContent = data.blood_type || 'æœªçŸ¥';

            // æ¸²æŸ“å¹´é¾„
            document.getElementById('age').textContent = (data.age || '?') + 'å²';

            // å¤„ç†è¿‡æ•å²
            const allergyInfo = extractAllergy(data.conditions);
            if (allergyInfo && allergyInfo !== 'æ— å·²çŸ¥è¿‡æ•') {
                renderTags('allergy-container', [allergyInfo], 'æ— å·²çŸ¥è¿‡æ•');
            } else {
                renderTags('allergy-container', [], 'æ— å·²çŸ¥è¿‡æ•');
            }

            // å¤„ç†æ­£åœ¨æœè¯
            const medicationsTags = data.medications ? parseConditionsToTags(data.medications) : [];
            renderTags('medications-container', medicationsTags, 'æ— æ­£åœ¨æœç”¨è¯ç‰©');

            // å¤„ç†æ—¢å¾€ç—…å²ï¼ˆæ’é™¤è¿‡æ•ç›¸å…³å†…å®¹ï¼‰
            let historyTags = [];
            if (data.conditions) {
                const conditionsTags = parseConditionsToTags(data.conditions);
                const allergyKeywords = ['è¿‡æ•', 'è¿‡æ•å²', 'è¿‡æ•æº', 'ä¸åƒ', 'ä¸æœ', 'ä¸èƒ½åƒ', 'ä¸èƒ½æœ', 'ç¦ç”¨', 'å¿Œç”¨'];
                historyTags = conditionsTags.filter(tag => 
                    !allergyKeywords.some(keyword => tag.includes(keyword))
                );
            }
            
            if (historyTags.length > 0) {
                document.getElementById('history-card').classList.remove('hidden');
                renderTags('history-container', historyTags, 'æ— é‡å¤§ç—…å²');
            } else {
                document.getElementById('history-card').classList.add('hidden');
            }

            // æ¸²æŸ“æ›´æ–°æ—¶é—´
            let updateTime = '';
            if (data.update_time) {
                updateTime = formatDate(data.update_time);
            } else if (data.create_time) {
                updateTime = formatDate(data.create_time);
            }
            document.getElementById('update-time').textContent = 'æœ€åæ›´æ–°ï¼š' + (updateTime || 'æœªçŸ¥');

            // æ¸²æŸ“ç´§æ€¥è”ç³»äººç”µè¯æŒ‰é’®
            if (data.contact_phone) {
                document.getElementById('fixed-footer').classList.remove('hidden');
                document.getElementById('call-btn').href = `tel:${data.contact_phone}`;
            } else {
                document.getElementById('fixed-footer').classList.add('hidden');
            }
        }

        // è·³è½¬åˆ°å°ç¨‹åº (ç®€åŒ–ç‰ˆï¼šç›´æ¥ä½¿ç”¨ URL Link)
        function jumpToMiniProgram() {
            const btn = document.querySelector('.convert-btn');
            const originalText = btn.innerText;

            // 1. Loading UI
            btn.innerText = 'æ­£åœ¨å‰å¾€å°ç¨‹åº...';
            btn.style.opacity = '0.7';
            btn.style.pointerEvents = 'none';

            // 2. ç›´æ¥è·³è½¬
            // TODO: User needs to replace this URL with the one generated from the Mini Program
            // Example format: https://wxaurl.cn/AbCdEfG
            const jumpUrl = 'REPLACE_WITH_YOUR_URL_LINK';

            if (jumpUrl === 'REPLACE_WITH_YOUR_URL_LINK') {
                alert('è¯·å¼€å‘è€…åœ¨ä»£ç ä¸­é…ç½®æœ‰æ•ˆçš„è·³è½¬é“¾æ¥');
                btn.innerText = originalText;
                btn.style.opacity = '1';
                btn.style.pointerEvents = 'auto';
                return;
            }

            window.location.href = jumpUrl;

            // Reset UI after delay (in case user comes back)
            setTimeout(() => {
                btn.innerText = originalText;
                btn.style.opacity = '1';
                btn.style.pointerEvents = 'auto';
            }, 3000);
        }

        // é¡µé¢åŠ è½½å®Œæˆååˆå§‹åŒ–ï¼ˆç¡®ä¿ CloudBase SDK å·²åŠ è½½ï¼‰
        function startInit() {
            if (typeof cloudbase === 'undefined') {
                console.error('CloudBase SDK æœªåŠ è½½ï¼Œè¯·æ£€æŸ¥ç½‘ç»œè¿æ¥æˆ– CDN æ˜¯å¦å¯è®¿é—®');
                document.getElementById('loading').classList.add('hidden');
                document.getElementById('error').classList.remove('hidden');
                const errorMsg = document.getElementById('error-msg');
                if (errorMsg) {
                    errorMsg.textContent = 'SDK åŠ è½½å¤±è´¥ï¼Œè¯·æ£€æŸ¥ç½‘ç»œè¿æ¥ååˆ·æ–°é¡µé¢';
                }
                return;
            }
            init();
        }

        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', startInit);
        } else {
            setTimeout(startInit, 100);
        }
    </script>
</body>

</html>
